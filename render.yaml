# Render Infrastructure as Code (IaC)
# This file defines all services and databases for automatic deployment
# Documentation: https://render.com/docs/infrastructure-as-code

services:
  # Backend API Service
  - type: web
    name: cryptowallet-api
    runtime: node
    region: oregon  # Change to your preferred region
    plan: starter   # Options: starter, standard, pro, pro plus
    branch: main
    rootDir: backend/backend/api
    buildCommand: npm install && npm run prisma:generate && npm run build
    startCommand: npm run migrate:deploy && npm run start:prod
    healthCheckPath: /health
    
    # Environment Variables
    envVars:
      # Application Configuration
      - key: NODE_ENV
        value: production
      
      # Database Connection (linked to database below)
      - key: DATABASE_URL_PROD
        fromDatabase:
          name: cryptowallet-db-prod
          property: connectionString
      
      # JWT Authentication (auto-generated on first deploy)
      - key: JWT_SECRET
        generateValue: true  # Render generates a secure random value
      
      # Payment Provider Secrets (must be set manually in Render Dashboard)
      # These contain sensitive API keys and cannot be in this file
      - key: MOONPAY_WEBHOOK_SECRET
        sync: false  # Must be set in Render Dashboard → Environment
      
      # CORS Configuration (must be set manually)
      - key: CORS_ALLOWED_ORIGINS
        sync: false  # Example: https://app.yourdomain.com,https://yourdomain.com
      
      # Optional: Advanced Configuration (uncomment if needed)
      # - key: PORT
      #   value: 3000
      # - key: LEDGER_INTEGRITY_INTERVAL_MS
      #   value: 900000
      # - key: PROVIDER_RECONCILIATION_INTERVAL_MS
      #   value: 3600000
      # - key: WEBHOOK_RETRY_INTERVAL_MS
      #   value: 300000
      # - key: WEBHOOK_MAX_RETRIES
      #   value: 3
      # - key: ALERT_BALANCE_MISMATCH_THRESHOLD
      #   value: 0.01
      # - key: ALERT_WEBHOOK_FAILURE_THRESHOLD
      #   value: 5
      # - key: ALERT_WEBHOOK_FAILURE_WINDOW_MINUTES
      #   value: 60
      # - key: ALERT_CREDIT_SPIKE_THRESHOLD
      #   value: 1000

databases:
  # PostgreSQL Database
  - name: cryptowallet-db-prod
    databaseName: cryptowallet
    user: cryptowallet_user
    region: oregon  # Should match web service region
    plan: starter   # Options: starter, standard, pro, pro plus
    ipAllowList: []  # Empty = allow all Render services

# After initial deployment:
# 1. Set MOONPAY_WEBHOOK_SECRET in Render Dashboard → Environment
# 2. Set CORS_ALLOWED_ORIGINS in Render Dashboard → Environment
# 3. Verify DATABASE_URL_PROD is automatically populated
# 4. Verify JWT_SECRET is automatically generated
#
# To deploy:
# 1. Commit this file to your repository
# 2. Go to Render Dashboard → New → Blueprint
# 3. Connect your repository
# 4. Render will create all services defined here
