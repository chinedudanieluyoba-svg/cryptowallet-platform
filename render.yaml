# Render Infrastructure as Code (IaC)
# This file defines all services and databases for automatic deployment
# Documentation: https://render.com/docs/infrastructure-as-code

services:
  # Backend API Service
  - type: web
    name: cryptowallet-api
    runtime: node
    region: oregon  # Change to your preferred region
    plan: starter   # Options: starter, standard, pro, pro plus
    branch: main
    rootDir: backend/backend/api
    buildCommand: npm install && npm run prisma:generate && npm run build
    startCommand: npm run migrate:deploy && npm run start:prod
    healthCheckPath: /health
    
    # Environment Variables
    envVars:
      # Application Configuration
      - key: NODE_ENV
        value: production
      
      # Database Connection (linked to database below)
      # IMPORTANT: Update this placeholder value in Render Dashboard → Environment after first deployment
      # The database connection string will be available in the Database service details
      - key: DATABASE_URL_PROD
        value: PLACEHOLDER_UPDATE_IN_RENDER_DASHBOARD
      
      # JWT Authentication
      # IMPORTANT: Update this placeholder value in Render Dashboard → Environment after first deployment
      # Generate a secure value with: openssl rand -base64 32
      - key: JWT_SECRET
        value: PLACEHOLDER_UPDATE_IN_RENDER_DASHBOARD
      
      # Payment Provider Secrets (must be set manually in Render Dashboard)
      # These contain sensitive API keys and cannot be in this file
      # IMPORTANT: Update this placeholder value in Render Dashboard → Environment after first deployment
      - key: MOONPAY_WEBHOOK_SECRET
        value: PLACEHOLDER_UPDATE_IN_RENDER_DASHBOARD
      
      # CORS Configuration (must be set manually after deployment)
      # IMPORTANT: Update this placeholder value in Render Dashboard → Environment after first deployment
      # Example: https://app.yourdomain.com,https://yourdomain.com
      - key: CORS_ALLOWED_ORIGINS
        value: PLACEHOLDER_UPDATE_IN_RENDER_DASHBOARD
      
      # Optional: Advanced Configuration (uncomment if needed)
      # - key: PORT
      #   value: 3000
      # - key: LEDGER_INTEGRITY_INTERVAL_MS
      #   value: 900000
      # - key: PROVIDER_RECONCILIATION_INTERVAL_MS
      #   value: 3600000
      # - key: WEBHOOK_RETRY_INTERVAL_MS
      #   value: 300000
      # - key: WEBHOOK_MAX_RETRIES
      #   value: 3
      # - key: ALERT_BALANCE_MISMATCH_THRESHOLD
      #   value: 0.01
      # - key: ALERT_WEBHOOK_FAILURE_THRESHOLD
      #   value: 5
      # - key: ALERT_WEBHOOK_FAILURE_WINDOW_MINUTES
      #   value: 60
      # - key: ALERT_CREDIT_SPIKE_THRESHOLD
      #   value: 1000

databases:
  # PostgreSQL Database
  - name: cryptowallet-db-prod
    databaseName: cryptowallet
    user: cryptowallet_user
    region: oregon  # Should match web service region
    plan: starter   # Options: starter, standard, pro, pro plus
    ipAllowList: []  # Empty = allow all Render services

# After initial deployment:
# 1. The app will start with placeholder values for DATABASE_URL_PROD, JWT_SECRET, MOONPAY_WEBHOOK_SECRET, and CORS_ALLOWED_ORIGINS
# 2. Check the logs for "CRITICAL WARNING" messages about placeholder values
# 3. Go to Render Dashboard → Your Service → Environment tab
# 4. Update DATABASE_URL_PROD with the Internal Database URL from your PostgreSQL service
#    - Go to your database service → Connection → Internal Database URL → Copy
# 5. Update JWT_SECRET with a secure random value
#    - Generate with: openssl rand -base64 32
#    - Or use Render's "Generate" button
# 6. Update MOONPAY_WEBHOOK_SECRET with your actual MoonPay webhook secret
# 7. Update CORS_ALLOWED_ORIGINS with your actual frontend domain(s)
# 8. Click "Save Changes" - Render will automatically restart the service
#
# To deploy:
# 1. Commit this file to your repository
# 2. Go to Render Dashboard → New → Blueprint
# 3. Connect your repository
# 4. Render will create all services defined here
